local FlashAttackModule = {}

_G.FlashAttackEnabled = _G.FlashAttackEnabled or false 

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer
local attackConnection = nil
local fastAttackInstance = nil
local lastScanTime = 0
local cachedBladeHits = {}

local Config = {
    AttackDistance = 5000,           
    AttackMobs = true,               
    AttackPlayers = true,            
    AttackCooldown = 0.01,           
    ComboResetTime = 0.5,            
    MaxCombo = 3,                    
    OptimizedScanInterval = 0.01     
}

local FastAttack = {}
FastAttack.__index = FastAttack

function FastAttack.new()
    return setmetatable({
        Debounce = 0,
        ComboDebounce = 0,
        M1Combo = 0,
    }, FastAttack) 
end

function FastAttack:IsEntityAlive(entity)
    local humanoid = entity and entity:FindFirstChild("Humanoid")
    return humanoid and humanoid.Health > 0 
end

function FastAttack:GetBladeHits(Character)
    if tick() - lastScanTime < Config.OptimizedScanInterval and #cachedBladeHits > 0 then
        return cachedBladeHits 
    end
    
    local Position = Character:GetPivot().Position
    local BladeHits = {}
    
    local function ProcessTargets(Folder)
        if not Folder then return end
        for _, Enemy in ipairs(Folder:GetChildren()) do
            if Enemy ~= Character and self:IsEntityAlive(Enemy) then
                local BasePart = Enemy:FindFirstChild("HumanoidRootPart")
                if BasePart and (Position - BasePart.Position).Magnitude <= Config.AttackDistance then
                    table.insert(BladeHits, {Enemy, BasePart}) 
                end
            end
        end
    end
    
    if Config.AttackMobs then ProcessTargets(Workspace.Enemies) end 
    if Config.AttackPlayers then ProcessTargets(Workspace.Characters) end 
    
    lastScanTime = tick()
    cachedBladeHits = BladeHits
    return BladeHits 
end

function FastAttack:GetCombo()
    local Combo = (tick() - self.ComboDebounce) <= Config.ComboResetTime and self.M1Combo or 0 
    Combo = Combo >= Config.MaxCombo and 1 or Combo + 1 
    self.ComboDebounce = tick()
    self.M1Combo = Combo
    return Combo 
end

function FastAttack:Attack()
    if not _G.FlashAttackEnabled or (tick() - self.Debounce) < Config.AttackCooldown then return end 
    
    local Character = Player.Character
    if not Character or not self:IsEntityAlive(Character) then return end 
    
    local Equipped = Character:FindFirstChildOfClass("Tool")
    
    if not Equipped or Equipped.ToolTip ~= "Blox Fruit" or not Equipped:FindFirstChild("LeftClickRemote") then return end 
    
    local Combo = self:GetCombo()
    local Targets = self:GetBladeHits(Character) 
    
    if Targets[1] then
        local Direction = (Targets[1][2].Position - Character:GetPivot().Position).Unit 
        Equipped.LeftClickRemote:FireServer(Direction, Combo) 
    end
    
    self.Debounce = tick() 
end

if not attackConnection then
    fastAttackInstance = FastAttack.new() 
    attackConnection = RunService.Heartbeat:Connect(function()
        if fastAttackInstance then
            fastAttackInstance:Attack() 
        end
    end)
end
