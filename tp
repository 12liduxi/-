local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer

local Config = {
    TeleportSpeed = 300,      
    TeleportHeight = 3,       
    TP_Enabled = false,
    Tween_Enabled = false,
    Noclip = true,
    UpdateRate = 0.02, 
    Smoothness = 0.15  
}

local TargetPlayer = nil
local MainLoop = nil
local NoclipLoop = nil
local UIFolded = false

local function SetNoclip(state)
    if state then
        if NoclipLoop then NoclipLoop:Disconnect() end
        NoclipLoop = RunService.Stepped:Connect(function()
            if LocalPlayer.Character then
                for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                    if part:IsA("BasePart") then part.CanCollide = false end
                end
            end
        end)
    else
        if NoclipLoop then NoclipLoop:Disconnect(); NoclipLoop = nil end
    end
end

local function CreateToggle(parent, position, callback)
    local ToggleBg = Instance.new("Frame")
    ToggleBg.Size = UDim2.new(0, 45, 0, 22)
    ToggleBg.Position = position
    ToggleBg.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
    ToggleBg.Parent = parent
    Instance.new("UICorner", ToggleBg).CornerRadius = UDim.new(1, 0)
    
    local Knob = Instance.new("Frame")
    Knob.Size = UDim2.new(0, 18, 0, 18)
    Knob.Position = UDim2.new(0, 2, 0.5, -9)
    Knob.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    Knob.Parent = ToggleBg
    Instance.new("UICorner", Knob).CornerRadius = UDim.new(1, 0)
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    Button.Parent = ToggleBg
    
    local active = false
    Button.MouseButton1Click:Connect(function()
        active = not active
        TweenService:Create(Knob, TweenInfo.new(0.2), {
            Position = active and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
        }):Play()
        TweenService:Create(ToggleBg, TweenInfo.new(0.2), {
            BackgroundColor3 = active and Color3.fromRGB(60, 180, 60) or Color3.fromRGB(50, 50, 55)
        }):Play()
        callback(active)
    end)
end

local function UpdateTeleportLogic()
    if MainLoop then MainLoop:Disconnect(); MainLoop = nil end
    SetNoclip(false)

    if (Config.TP_Enabled or Config.Tween_Enabled) and TargetPlayer then
        if Config.Tween_Enabled then SetNoclip(true) end

        MainLoop = RunService.Heartbeat:Connect(function(dt)
            local char = LocalPlayer.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            local targetChar = TargetPlayer.Character
            local targetHrp = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
            
            if hrp and targetHrp then
                local targetPosition = targetHrp.Position + Vector3.new(0, Config.TeleportHeight, 0)
                local lookVector = (targetPosition - hrp.Position).Unit
                local targetCFrame = CFrame.new(targetPosition, targetPosition + lookVector)

                if Config.Tween_Enabled then
                    local dist = (targetPosition - hrp.Position).Magnitude
                    if dist > 0.1 then
                        hrp.Velocity = Vector3.new(0, 0, 0) 
                        hrp.CFrame = hrp.CFrame:Lerp(targetCFrame, math.min((Config.TeleportSpeed * dt) / dist, 1))
                    end
                elseif Config.TP_Enabled then
                    hrp.CFrame = targetCFrame
                end
            end
            task.wait(Config.UpdateRate)
        end)
    end
end

local function CreateUI()
    local oldUI = game:GetService("CoreGui"):FindFirstChild("Bypasstp_Ghost_V4")
    if oldUI then oldUI:Destroy() end

    local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
    ScreenGui.Name = "Bypasstp_Ghost_V4"
    
    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Size = UDim2.new(0, 440, 0, 320)
    MainFrame.Position = UDim2.new(0.5, -220, 0.5, -160)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    MainFrame.ClipsDescendants = true
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
    
    local TitleBar = Instance.new("Frame", MainFrame)
    TitleBar.Size = UDim2.new(1, 0, 0, 35)
    TitleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    Instance.new("UICorner", TitleBar).CornerRadius = UDim.new(0, 10)
    
    local Title = Instance.new("TextLabel", TitleBar)
    Title.Text = "  楊改瑞的癖眼派對"
    Title.Size = UDim2.new(1, -100, 1, 0)
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 14
    Title.TextXAlignment = Enum.TextXAlignment.Left

    -- --- 核心修改：確認關閉通知系統 ---
    local CloseBtn = Instance.new("TextButton", TitleBar)
    CloseBtn.Size = UDim2.new(0, 35, 0, 35)
    CloseBtn.Position = UDim2.new(1, -35, 0, 0)
    CloseBtn.Text = "×"
    CloseBtn.TextColor3 = Color3.fromRGB(255, 80, 80)
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.TextSize = 24
    
    CloseBtn.MouseButton1Click:Connect(function()
        local bindable = Instance.new("BindableFunction")
        
        bindable.OnInvoke = function(answer)
            if answer == "確定" then
                if MainLoop then MainLoop:Disconnect() end
                if NoclipLoop then NoclipLoop:Disconnect() end
                ScreenGui:Destroy()
            end
        end

        StarterGui:SetCore("SendNotification", {
            Title = "腳本關閉確認",
            Text = "確定要關閉腳本嗎？",
            Duration = 5,
            Callback = bindable,
            Button1 = "確定",
            Button2 = "取消"
        })
    end)
    -- --- 核心修改結束 ---

    local FoldButton = Instance.new("TextButton", TitleBar)
    FoldButton.Size = UDim2.new(0, 35, 0, 35)
    FoldButton.Position = UDim2.new(1, -70, 0, 0)
    FoldButton.Text = "−" 
    FoldButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    FoldButton.BackgroundTransparency = 1
    FoldButton.Font = Enum.Font.GothamBold
    FoldButton.TextSize = 20
    
    local LeftSide = Instance.new("Frame", MainFrame)
    LeftSide.Size = UDim2.new(0.6, -15, 1, -50)
    LeftSide.Position = UDim2.new(0, 10, 0, 40)
    LeftSide.BackgroundTransparency = 1

    local RightSide = Instance.new("Frame", MainFrame)
    RightSide.Size = UDim2.new(0.4, -15, 1, -50)
    RightSide.Position = UDim2.new(0.6, 5, 0, 40)
    RightSide.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Instance.new("UICorner", RightSide).CornerRadius = UDim.new(0, 8)

    local function ToggleFold()
        UIFolded = not UIFolded
        if UIFolded then
            MainFrame:TweenSize(UDim2.new(0, 440, 0, 35), "Out", "Quad", 0.3, true)
            LeftSide.Visible = false
            RightSide.Visible = false
            FoldButton.Text = "+"
        else
            MainFrame:TweenSize(UDim2.new(0, 440, 0, 320), "Out", "Quad", 0.3, true)
            task.wait(0.2)
            LeftSide.Visible = true
            RightSide.Visible = true
            FoldButton.Text = "−"
        end
    end
    FoldButton.MouseButton1Click:Connect(ToggleFold)

    local SearchBox = Instance.new("TextBox", LeftSide)
    SearchBox.Size = UDim2.new(1, 0, 0, 30)
    SearchBox.PlaceholderText = " 搜尋玩家名稱或ID..."
    SearchBox.Text = ""
    SearchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    SearchBox.Font = Enum.Font.Gotham
    SearchBox.TextSize = 13
    Instance.new("UICorner", SearchBox).CornerRadius = UDim.new(0, 6)
    
    local ListScroll = Instance.new("ScrollingFrame", LeftSide)
    ListScroll.Size = UDim2.new(1, 0, 1, -35)
    ListScroll.Position = UDim2.new(0, 0, 0, 35)
    ListScroll.BackgroundTransparency = 1
    ListScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    ListScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ListScroll.ScrollBarThickness = 4
    local ListLayout = Instance.new("UIListLayout", ListScroll)
    ListLayout.Padding = UDim.new(0, 5)

    local function CreateInfoLabel(text, yPos, color)
        local lbl = Instance.new("TextLabel", RightSide)
        lbl.Size = UDim2.new(1, -10, 0, 40)
        lbl.Position = UDim2.new(0, 5, 0, yPos)
        lbl.Text = text
        lbl.TextColor3 = color or Color3.fromRGB(200, 200, 200)
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.GothamSemibold
        lbl.TextSize = 12
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.TextWrapped = true
        return lbl
    end
    
    local TargetStatus = CreateInfoLabel("目標: 未選擇", 5, Color3.fromRGB(150, 150, 255))
    local DistStatus = CreateInfoLabel("距離: -", 45, Color3.fromRGB(150, 255, 150))
    
    local RightSide = Instance.new("Frame", MainFrame)
    RightSide.Size = UDim2.new(0.4, -15, 1, -50)
    RightSide.Position = UDim2.new(0.6, 5, 0, 40)
    RightSide.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Instance.new("UICorner", RightSide).CornerRadius = UDim.new(0, 8)

    local SearchBox = Instance.new("TextBox", LeftSide)
    SearchBox.Size = UDim2.new(1, 0, 0, 30)
    SearchBox.PlaceholderText = " 搜尋玩家名稱..."
    SearchBox.Text = ""
    SearchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    SearchBox.Font = Enum.Font.Gotham
    SearchBox.TextSize = 13
    Instance.new("UICorner", SearchBox).CornerRadius = UDim.new(0, 6)
    
    local ListScroll = Instance.new("ScrollingFrame", LeftSide)
    ListScroll.Size = UDim2.new(1, 0, 1, -35)
    ListScroll.Position = UDim2.new(0, 0, 0, 35)
    ListScroll.BackgroundTransparency = 1
    ListScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    ListScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ListScroll.ScrollBarThickness = 4
    Instance.new("UIListLayout", ListScroll).Padding = UDim.new(0, 5)

    local function CreateInfoLabel(text, yPos, color)
        local lbl = Instance.new("TextLabel", RightSide)
        lbl.Size = UDim2.new(1, -10, 0, 35)
        lbl.Position = UDim2.new(0, 5, 0, yPos)
        lbl.Text = text
        lbl.TextColor3 = color or Color3.fromRGB(200, 200, 200)
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.GothamSemibold
        lbl.TextSize = 12
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        return lbl
    end
    
    local TargetStatus = CreateInfoLabel("目標: 未選擇", 5, Color3.fromRGB(150, 150, 255))
    local DistStatus = CreateInfoLabel("距離: -", 40, Color3.fromRGB(150, 255, 150))
    
    CreateInfoLabel("Teleport", 80, Color3.fromRGB(255, 100, 100))
    CreateToggle(RightSide, UDim2.new(1, -50, 0, 85), function(state)
        Config.TP_Enabled = state
        UpdateTeleportLogic()
    end)

    CreateInfoLabel("Tween", 115, Color3.fromRGB(100, 255, 255))
    CreateToggle(RightSide, UDim2.new(1, -50, 0, 120), function(state)
        Config.Tween_Enabled = state
        UpdateTeleportLogic()
    end)

    -- 新增：View Player 功能
    CreateInfoLabel("View Player", 150, Color3.fromRGB(255, 200, 100))
    CreateToggle(RightSide, UDim2.new(1, -50, 0, 155), function(state)
        local cam = workspace.CurrentCamera
        if state and TargetPlayer and TargetPlayer.Character then
            local hum = TargetPlayer.Character:FindFirstChildOfClass("Humanoid")
            if hum then cam.CameraSubject = hum end
        else
            if LocalPlayer.Character then
                cam.CameraSubject = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            end
        end
    end)

    CreateInfoLabel("飛行速度:", 195)
    local SpeedInput = Instance.new("TextBox", RightSide)
    SpeedInput.Size = UDim2.new(0, 60, 0, 25)
    SpeedInput.Position = UDim2.new(1, -65, 0, 200)
    SpeedInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    SpeedInput.Text = tostring(Config.TeleportSpeed)
    SpeedInput.TextColor3 = Color3.fromRGB(255, 255, 100)
    Instance.new("UICorner", SpeedInput).CornerRadius = UDim.new(0, 4)
    SpeedInput.FocusLost:Connect(function()
        Config.TeleportSpeed = tonumber(SpeedInput.Text) or 300
    end)

    local function UpdateList()
        for _, v in ipairs(ListScroll:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
        for _, p in ipairs(Players:GetPlayers()) do
            local fullLabel = p.DisplayName .. " (@" .. p.Name .. ")"
            if p ~= LocalPlayer and (SearchBox.Text == "" or string.find(fullLabel:lower(), SearchBox.Text:lower())) then
                local btn = Instance.new("TextButton", ListScroll)
                btn.Size = UDim2.new(1, -8, 0, 40)
                btn.BackgroundColor3 = (TargetPlayer == p) and Color3.fromRGB(60, 60, 120) or Color3.fromRGB(45, 45, 50)
                btn.Text = "  " .. fullLabel
                btn.TextColor3 = Color3.fromRGB(255, 255, 255)
                btn.Font = Enum.Font.GothamSemibold
                btn.TextSize = 12
                btn.TextXAlignment = Enum.TextXAlignment.Left
                btn.TextTruncate = Enum.TextTruncate.AtEnd
                Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
                
                btn.MouseButton1Click:Connect(function()
                    TargetPlayer = p
                    TargetStatus.Text = "目標: " .. p.DisplayName .. "\n(@" .. p.Name .. ")"
                    UpdateList()
                    UpdateTeleportLogic()
                end)
            end
        end
    end
    SearchBox:GetPropertyChangedSignal("Text"):Connect(UpdateList)
    UpdateList()

    RunService.RenderStepped:Connect(function()
        if TargetPlayer and TargetPlayer.Character and LocalPlayer.Character then
            local tHrp = TargetPlayer.Character:FindFirstChild("HumanoidRootPart")
            local mHrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if tHrp and mHrp then
                DistStatus.Text = string.format("距離: %.1f 米", (tHrp.Position - mHrp.Position).Magnitude)
            end
        end
    end)

    local dragging, dragStart, startPos
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input) dragging = false end)
end

CreateUI()

-- 自動刷新玩家清單邏輯
task.spawn(function()
    while task.wait(5) do
        -- 檢查 UI 是否仍然存在，避免腳本關閉後繼續運行
        local screenGui = game:GetService("CoreGui"):FindFirstChild("Bypasstp_Ghost_V4")
        if screenGui then
            UpdateList()
        else
            break -- UI 已關閉，停止循環
        end
    end
end)
